import h5py
from connect_db import connect_db
from not_embedded_logos import embed_logos
from logos_loader import generate_logo
import torch
from transformers import CLIPModel, CLIPImageProcessor, CLIPProcessor
from sklearn.metrics.pairwise import cosine_similarity
from script import save_logo_embeddings
import requests
from io import BytesIO
import numpy as np
from PIL import Image

def get_known_embedding():
    with h5py.File("logos_embeddings_512.hdf5", 'r') as f: 
        logos = f['embedding']
        ids = f['external_id']
        id1 = ids[0]
        embedding1 = logos[0] 
        id2 = ids[1]
        embedding2 = logos[1] 
    return id1, embedding1, id2, embedding2

def get_logo_infos(id1, id2):
    infos1, infos2 = connect_db(id1, id2)
    return infos1[0], infos1[1], infos1[2], infos2[0], infos2[1], infos2[2]


device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
print("device done")
model = CLIPModel.from_pretrained(f"openai/clip-vit-base-patch32").to(device)
print("model done")
processor = CLIPImageProcessor()
print("processor done")

id1, former_embedding1, id2, former_embedding2 = get_known_embedding()
print("get_known_embedding done")
id1 = 4873876
source_img1, bounding_box1, id_check_1, source_img2, bounding_box2, id_check_2 = get_logo_infos(id1, id2)
print("get_logo_infos done")
logo1 = generate_logo(id1, source_img1, bounding_box1)
logo2 = generate_logo(id2, source_img2, bounding_box2)
print("generate_logo done")
new_embedding1 = embed_logos([logo1], device, processor, model)
new_embedding2 = embed_logos([logo2], device, processor, model)
print("embed_logos done")

print("testing pil")
r = requests.get("https://openfoodfacts.org/images/products" + source_img1)
image1 = Image.open(BytesIO(r.content))
pil_embedding_1 = save_logo_embeddings([bounding_box1], image1)
r = requests.get("https://openfoodfacts.org/images/products" + source_img2)
image2 = Image.open(BytesIO(r.content))
pil_embedding_2 = save_logo_embeddings([bounding_box2], image2)


print(cosine_similarity(former_embedding1.reshape(1,512),former_embedding2.reshape(1,512)))
print(cosine_similarity(new_embedding1.reshape(1,512),new_embedding2.reshape(1,512)))
print(cosine_similarity(former_embedding1.reshape(1,512),new_embedding1.reshape(1,512)))
print(cosine_similarity(former_embedding2.reshape(1,512),new_embedding2.reshape(1,512)))
print("||||||")
print(cosine_similarity(former_embedding1.reshape(1,512),former_embedding2.reshape(1,512)))
print(cosine_similarity(pil_embedding_1.reshape(1,512),pil_embedding_2.reshape(1,512)))
print(cosine_similarity(former_embedding1.reshape(1,512),pil_embedding_1.reshape(1,512)))
print(cosine_similarity(former_embedding2.reshape(1,512),pil_embedding_2.reshape(1,512)))
print("||||||")
print(cosine_similarity(pil_embedding_1.reshape(1,512),pil_embedding_2.reshape(1,512)))
print(cosine_similarity(new_embedding1.reshape(1,512),new_embedding2.reshape(1,512)))
print(cosine_similarity(pil_embedding_1.reshape(1,512),new_embedding1.reshape(1,512)))
print(cosine_similarity(pil_embedding_2.reshape(1,512),new_embedding2.reshape(1,512)))



embedding_written = np.array([ 1.12663331e-02,  3.07077002e-02, -1.40491826e-02, -2.63949577e-02,
        3.36622633e-02, -1.49499753e-03,  1.68420635e-02,  4.53768857e-02,
       -5.53265996e-02, -1.88987311e-02,  1.47482809e-02,  5.62142441e-03,
        5.12128323e-02, -8.34356714e-03,  1.52246626e-02, -1.86469255e-03,
        1.26240738e-02,  2.53308890e-03,  1.22876535e-03,  4.31618243e-02,
       -3.24303582e-02,  1.15787135e-02, -5.25982911e-03, -6.67449739e-03,
       -9.41784400e-03, -9.42712091e-03, -2.37162095e-02, -1.27444519e-02,
       -5.90222608e-03, -2.26560235e-03,  1.31651284e-02,  1.80351045e-02,
        8.29818752e-03, -5.08522708e-03, -2.13792343e-02, -4.36735377e-02,
       -5.34816496e-02, -1.43015115e-02,  2.04640944e-02, -1.04063824e-01,
        1.23887509e-02, -3.99838993e-03, -9.78974812e-03, -6.77438267e-03,
        2.60866154e-03,  5.48279993e-02,  2.50123609e-02,  2.36303601e-02,
       -4.40627635e-02, -1.53439296e-02,  2.84089390e-02, -6.59030117e-03,
        1.98749676e-02, -8.15693941e-03, -1.82075668e-02, -3.51485470e-03,
        1.16699496e-02,  1.60522107e-02,  1.09746484e-02, -7.17977248e-03,
        3.90058756e-02, -1.78961959e-02,  2.02557445e-02, -5.27352318e-02,
        5.33150975e-03, -5.15539609e-02, -4.53390134e-03, -1.89282019e-02,
       -1.61494017e-02, -6.82345126e-03, -2.35412437e-02,  9.46221501e-03,
       -6.08041417e-03, -1.14532858e-02, -6.31874101e-03,  1.14906682e-02,
       -1.21234600e-02,  1.40801026e-02, -1.99143887e-02, -2.78686173e-02,
        1.71061102e-02,  8.04391876e-03,  7.36936182e-03, -1.85999759e-02,
        4.52734903e-03,  2.62544826e-02,  2.66385376e-02,  3.91796371e-03,
       -3.04467585e-02, -5.91540150e-02,  2.53752829e-03, -4.28374261e-02,
       -7.84364343e-01,  2.35131681e-02,  1.17356833e-02,  6.97738072e-03,
        2.93299705e-02,  9.17606615e-03, -2.49524810e-03,  8.60549603e-03,
        1.21339345e-02,  8.78683478e-03,  4.38545868e-02, -1.27296215e-02,
        2.93382891e-02,  1.49841569e-02, -9.56781060e-02,  3.20738405e-02,
        3.36993160e-03, -2.12609004e-02,  6.54183095e-03,  1.08946869e-02,
       -4.84295981e-03, -3.43791619e-02, -6.71516114e-04, -1.54161202e-02,
       -2.16306373e-02, -5.82256261e-03,  3.19632851e-02,  3.81365344e-02,
       -4.17522974e-02, -7.43547780e-03,  9.89300571e-03,  4.11612913e-02,
        2.70416494e-03, -2.99667213e-02,  4.35793912e-03,  1.13989459e-02,
       -3.35928611e-02,  2.31215321e-02,  1.67579148e-02, -5.45212738e-02,
       -3.45727578e-02,  9.59246606e-02,  2.08950303e-02,  2.17842180e-02,
        6.66021183e-03, -4.09821570e-02, -1.13714710e-02, -1.19911594e-04,
        2.93420022e-03,  8.53326812e-04, -3.39674503e-02, -7.12935347e-03,
       -2.84644980e-02,  2.80066971e-02,  3.78259458e-02, -3.97818349e-03,
       -9.60489153e-04, -1.13054216e-02, -8.48971307e-03, -2.22651865e-02,
        6.09289706e-02,  7.64764426e-03,  8.31914041e-03, -1.70091651e-02,
        7.35325040e-03,  1.10809579e-02,  5.62011357e-03,  8.99512880e-03,
        2.88071315e-04,  2.82625109e-02, -2.80441507e-03,  1.30452719e-02,
       -2.45588948e-03,  7.22533185e-03,  1.28358172e-03, -5.11959754e-03,
        3.21500078e-02, -9.50217061e-03, -7.76605122e-03, -2.56929249e-02,
        3.12272040e-03,  5.64758759e-03, -4.86651063e-03, -3.81734297e-02,
        4.21235189e-02, -3.46713187e-03, -1.32236304e-02,  6.90876879e-03,
       -4.74822074e-02, -3.30839772e-04, -5.56093967e-03,  3.16549768e-03,
       -1.79066099e-02, -1.27075519e-02, -1.88577138e-02, -1.66158210e-02,
       -6.74423715e-03,  9.58560035e-03,  3.91076040e-03, -6.88651484e-03,
        1.30779268e-02, -4.19498328e-03,  6.28700061e-03,  5.56875020e-03,
        2.91162878e-02,  2.51626372e-02, -5.71222417e-03,  3.51994671e-02,
        4.25114762e-03, -9.96632408e-03, -1.35748805e-02,  1.07676992e-02,
        2.05262396e-02,  2.70297546e-02, -5.71903475e-02, -1.76637564e-02,
       -2.35989429e-02, -9.81063582e-03, -2.10839268e-02,  4.19688486e-02,
       -2.54808553e-02,  2.91787460e-02,  1.14893420e-02,  2.45143747e-04,
       -4.55971174e-02,  4.09187563e-03,  1.22937718e-02, -2.95192786e-02,
        3.28172855e-02, -5.61093166e-03, -8.32376629e-03,  6.72221766e-04,
        1.16597367e-02, -2.04209350e-02,  3.05996067e-03, -3.46780457e-02,
       -1.01013081e-02,  1.78483222e-02,  3.91373895e-02,  1.19010936e-02,
        2.67386367e-03, -4.36329312e-04,  2.42470093e-02,  3.85186784e-02,
        1.43552441e-02, -6.50837971e-03, -1.49685070e-02, -1.43419905e-02,
        1.39543023e-02,  1.92857776e-02,  1.66811924e-02,  1.78234428e-02,
       -3.70063931e-02, -4.43504974e-02, -5.06866956e-03,  2.19710227e-02,
        4.11014631e-02, -1.09657450e-02, -1.64565984e-02,  5.95505862e-03,
       -8.32845271e-03, -6.62886631e-03, -1.91038277e-03, -3.53852920e-02,
       -8.40147492e-03,  6.82983024e-04, -9.98690873e-02,  6.47788541e-03,
        7.94073753e-03,  2.47047562e-02, -1.76626984e-02,  7.00575262e-02,
        1.87263880e-02,  4.87126596e-03,  4.91832104e-03, -3.10468525e-02,
       -1.33597087e-02, -3.87710072e-02,  3.63972448e-02,  1.68642662e-02,
        4.97537144e-02, -4.76349927e-02,  2.54569221e-02,  1.01290420e-02,
        3.66744995e-02,  1.61942877e-02,  3.62836272e-02,  2.53019854e-02,
        2.81066727e-03,  1.35489712e-02, -1.86140537e-02, -1.16778603e-02,
       -2.74882764e-02, -1.70769803e-02, -9.99388471e-03, -9.29544121e-03,
       -4.28599678e-02,  2.86343321e-03,  2.38412409e-03, -2.84440666e-02,
        2.54773833e-02,  3.29364128e-02,  5.65136876e-03,  4.66279015e-02,
        4.86020073e-02, -7.81008042e-03,  4.46143979e-03, -1.09252352e-02,
        2.33465694e-02, -1.27333533e-02,  2.77240276e-02, -1.99427716e-02,
       -1.13206496e-02, -4.93038930e-02,  1.83129846e-03,  1.30131235e-02,
       -1.55525832e-02,  9.62213147e-03, -2.14746203e-02,  1.61287952e-02,
        9.59778577e-02,  7.88739789e-03, -2.65697856e-02,  2.83744205e-02,
        2.14048978e-02, -1.63120124e-02,  8.93525372e-04, -3.69041972e-02,
        3.20626721e-02,  1.16831623e-01, -1.51185151e-02, -1.31053356e-02,
       -3.10454867e-03,  4.42680495e-04,  5.10453247e-02,  6.57089893e-03,
        1.94563828e-02,  6.17632940e-02, -2.58786548e-02, -3.82093363e-03,
        1.85556542e-02, -2.97729168e-02, -4.78192717e-02, -9.86138266e-03,
       -3.85141838e-03, -3.86845466e-04,  9.38405283e-03, -2.40721703e-02,
       -3.88682373e-02,  1.93787310e-02,  1.02090761e-02,  5.51253615e-04,
       -8.50573182e-03, -1.45149129e-02, -1.20434714e-02, -3.05352304e-02,
       -1.81973428e-02,  3.54206585e-03,  3.34373191e-02, -7.90234935e-03,
       -1.70439500e-02, -1.45419622e-02,  5.94443455e-02, -3.03023141e-02,
       -8.89317319e-03,  5.55993021e-02,  3.77277955e-02,  3.00389249e-02,
        2.16519199e-02, -5.59914042e-04,  1.31013095e-02, -6.48294538e-02,
       -2.69497652e-03,  1.38904285e-02, -1.66771524e-02,  1.33988578e-02,
       -3.14862980e-03, -1.22065069e-02, -3.10339909e-02,  1.37470635e-02,
        1.86009724e-02, -2.38021789e-03,  1.06018474e-02,  9.68254823e-03,
       -9.88304690e-02, -3.83800678e-02, -7.37929568e-02,  2.75631454e-02,
       -3.90285789e-03,  4.28136364e-02, -2.17864029e-02, -6.09728806e-02,
       -2.44296268e-02, -7.59206992e-03,  9.45246022e-04,  7.50241289e-03,
       -1.11593939e-02, -1.33606359e-01, -3.96603793e-02,  1.78785231e-02,
        1.94723085e-02, -4.19811271e-02,  3.77609245e-02, -3.47284488e-02,
        2.29284330e-03,  6.20086864e-03, -2.20842869e-03, -2.25619767e-02,
       -1.92540903e-02, -5.72945038e-03,  4.17586342e-02, -2.29136404e-02,
       -3.81858051e-02, -7.04681734e-03,  3.09272632e-02, -1.53430942e-02,
        1.27950785e-04,  8.17099027e-03,  1.47119910e-02, -5.29849296e-03,
        2.24434352e-03,  5.93737736e-02,  3.20367254e-02, -3.88202490e-03,
        2.25232486e-02,  8.10345542e-03,  2.25879047e-02, -3.07687949e-02,
       -1.23786442e-02,  1.24679669e-03,  3.19409370e-02, -1.22607080e-02,
        6.31849747e-03,  7.49928039e-03,  1.51784411e-02,  1.46967545e-02,
        9.79196280e-02,  2.47758776e-02,  1.01647368e-02,  1.93463750e-02,
       -1.42504531e-03, -1.11742299e-02, -1.16443653e-02, -8.34628195e-03,
       -3.03721409e-02, -1.25528174e-02,  3.40723880e-02,  2.48799194e-03,
       -4.84392680e-02,  3.16880047e-02,  2.95001213e-02,  1.98293012e-02,
        1.60917211e-02,  2.34539974e-02, -8.33585684e-04,  6.30730903e-03,
       -3.39632817e-02, -2.09941133e-03,  2.45521087e-02, -2.06062961e-02,
       -2.63393987e-02,  2.49141036e-03,  4.95282328e-03, -5.51238237e-03,
        2.73868777e-02, -3.20198908e-02, -4.68724109e-02, -4.54064310e-02,
       -1.50268748e-02,  1.42778521e-02, -3.32347723e-03, -7.93358777e-03,
        2.39124205e-02,  5.54831512e-03, -3.51489335e-03, -3.68006229e-02,
       -8.06447864e-03, -3.26632485e-02,  8.50122049e-03,  3.30668576e-02,
        3.16312239e-02,  3.90298180e-02, -2.99038962e-02,  4.65845177e-03,
       -4.03292067e-02, -3.93546326e-03, -2.69122329e-02, -2.17666896e-03,
       -1.67008452e-02,  3.81525755e-02, -1.36024244e-02, -1.34977680e-02,
        1.96870118e-02,  4.61945310e-02,  3.33198608e-04, -1.61465127e-02,
        7.03179231e-03, -7.03811198e-02, -1.54975811e-02,  2.60899751e-03,
       -6.23868196e-04,  1.14197321e-02,  1.32476678e-02, -1.39189744e-02,
       -2.13388372e-02, -1.77308545e-02,  9.28489957e-03, -1.17776534e-02,
       -5.12412144e-03,  2.30227113e-02,  3.10984906e-02,  3.36933951e-03,
        1.36345085e-02, -2.14229282e-02, -2.71006692e-02, -4.96568019e-03,
       -3.95382904e-02,  9.86573286e-03,  1.11555727e-02, -3.58633474e-02],
      dtype=np.float32)



breakpoint()


